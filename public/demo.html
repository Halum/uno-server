


<!DOCTYPE html>
<html>
<head>
    <title>Socket.IO - Demo</title>
</head>
<body>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
<script>

const url = 'http://localhost:3500/uno';
let game = null;
let players = [];
let socket = null;

demo();

function demo() {
  createGame()
    .then(data => {
      game = data;
      console.log('Game created', game);

      return Promise.all([
        createPlayer('ab'),
        createPlayer('xy')
      ]);
    })
    .then(data => {
      players = data;
      console.log('Players created', players);
      
      let promises = [];

      for(let player of players) {
        promises.push(joinGame(game.id, player.id));
      }

      return Promise.all(promises);
    })
    .then(data => {
      console.log('Players joined', data);
      connectSocket(game.id);
      
      let promises = [];

      for(let player of players) {
        promises.push(playerReady(player.id));
      }

      return Promise.all(promises);
    })
    .then(data => {
      players = data;
      console.log('Players ready', players);
    });
}

function connectSocket(gameId) {
  console.log('connecting to socket', gameId);
  socket = io(`/${gameId}`);

  socket.on(gameId, console.log);
}

function post(path, data) {
  return fetch(url+path, {
    method: 'POST',
    body: JSON.stringify(data),
    headers:{'Content-Type': 'application/json'}
  })
  .then(res => res.json());
}

function createGame() {
  const path = '/new';

  return post(path, {});
}

function createPlayer(playerName) {
  const path = '/players/new';
  const data = {playerName};

  return post(path, data);
}

function joinGame(gameId, playerId) {
  const path = '/join';
  const data = {gameId, playerId};

  return post(path, data);
}

function playerReady(playerId) {
  const path = '/player/ready';
  const data = {playerId};

  return post(path, data);
}

</script>

</body>
</html>